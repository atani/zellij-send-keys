#!/bin/bash
# send-to-coaching - Send message to coaching staff member
# Usage: send-to-coaching <member> "message" [session]
# Members: coach, reviewer, tactician, qa-lead, coordinator, tester, worker-a, worker-b

set -e

MEMBER="$1"
MESSAGE=$(echo "$2" | tr '\n' ' ')  # Replace newlines with spaces
SESSION="$3"

if [ -z "$MEMBER" ] || [ -z "$MESSAGE" ]; then
    echo "Usage: send-to-coaching <member> \"message\" [session]"
    echo "Members: coach, reviewer, tactician, qa-lead, coordinator, tester, worker-a, worker-b"
    exit 1
fi

# Map member to pane ID
case "$MEMBER" in
    coach)       PANE_ID=0 ;;
    reviewer)    PANE_ID=1 ;;
    tactician)   PANE_ID=2 ;;
    qa-lead)     PANE_ID=3 ;;
    coordinator) PANE_ID=4 ;;
    tester)      PANE_ID=5 ;;
    worker-a)    PANE_ID=6 ;;
    worker-b)    PANE_ID=7 ;;
    *)
        echo "Unknown member: $MEMBER"
        echo "Valid members: coach, reviewer, tactician, qa-lead, coordinator, tester, worker-a, worker-b"
        exit 1
        ;;
esac

# Session: use argument, or ZELLIJ_SESSION env, or current repo name
if [ -n "$SESSION" ]; then
    ZELLIJ_SESSION="$SESSION"
elif [ -z "$ZELLIJ_SESSION" ]; then
    ZELLIJ_SESSION=$(basename "$PWD")
fi

if [ -z "$ZELLIJ_SESSION" ]; then
    echo "No active zellij session found"
    exit 1
fi

ZELLIJ_PLUGIN="file:$HOME/.config/zellij/plugins/zellij-send-keys.wasm"

# Build JSON payload safely using jq (-c for compact output)
JSON_PAYLOAD=$(jq -cn --argjson pane_id "$PANE_ID" --arg text "$MESSAGE" \
    '{pane_id: $pane_id, text: $text, send_enter: true}')

# Send message
ZELLIJ_SESSION_NAME="$ZELLIJ_SESSION" zellij action pipe \
    --plugin "$ZELLIJ_PLUGIN" \
    --name send_keys \
    -- "$JSON_PAYLOAD"

echo "Sent to $MEMBER (pane $PANE_ID)"
